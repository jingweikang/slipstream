<!DOCTYPE html>
<html>
<head>
    <title>Slipstream Activity Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }

        #controls h3 { margin: 0 0 10px 0; font-size: 16px; }

        .filter-group { margin-bottom: 15px; }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        .range-inputs {
            display: flex;
            gap: 10px;
        }
        .range-inputs input {
            flex: 1;
        }

        #activity-count {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 12px;
        }

        button {
            width: 100%;
            padding: 8px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover { background: #0056b3; }

        .popup-button {
            margin-top: 10px;
            padding: 5px 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .popup-button:hover { background: #218838; }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="controls">
        <h3>Filter Activities</h3>

        <div class="filter-group">
            <label>Activity Type:</label>
            <select id="type-filter">
                <option value="">All Types</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Distance Range (km):</label>
            <div class="range-inputs">
                <input type="number" id="min-distance" placeholder="Min" step="0.1">
                <input type="number" id="max-distance" placeholder="Max" step="0.1">
            </div>
        </div>

        <div class="filter-group">
            <label>Elevation Gain (m):</label>
            <div class="range-inputs">
                <input type="number" id="min-elevation" placeholder="Min" step="1">
                <input type="number" id="max-elevation" placeholder="Max" step="1">
            </div>
        </div>

        <button onclick="applyFilters()">Apply Filters</button>

        <div id="activity-count"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Polyline Decoder -->
    <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>

    <script>
        // Initialize map centered on San Francisco Bay Area
        const map = L.map('map').setView([37.5, -122.0], 10);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Marker cluster group
        let markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        let currentPolylines = [];
        let allActivities = [];

        // Color mapping for activity types
        const typeColors = {
            'Ride': '#FC4C02',
            'Run': '#00C46A',
            'Walk': '#4A90E2',
            'Hike': '#F5A623',
            'VirtualRide': '#BD10E0',
            'Swim': '#50E3C2',
            'EBikeRide': '#FF6B6B'
        };

        // Load filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const options = await response.json();

                const typeSelect = document.getElementById('type-filter');
                options.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Load and display activities
        async function loadActivities(filters = {}) {
            try {
                const params = new URLSearchParams();

                if (filters.type) params.append('type', filters.type);
                if (filters.min_distance) params.append('min_distance', filters.min_distance);
                if (filters.max_distance) params.append('max_distance', filters.max_distance);
                if (filters.min_elevation) params.append('min_elevation', filters.min_elevation);
                if (filters.max_elevation) params.append('max_elevation', filters.max_elevation);

                const response = await fetch(`/api/activities?${params}`);
                const data = await response.json();

                // Clear existing markers and polylines
                markers.clearLayers();
                currentPolylines.forEach(p => map.removeLayer(p));
                currentPolylines = [];

                allActivities = data.activities;

                // Add markers for each activity
                data.activities.forEach(activity => {
                    if (activity.start_latlng && activity.start_latlng.length === 2) {
                        const marker = L.marker([activity.start_latlng[0], activity.start_latlng[1]]);

                        // Popup content
                        const distanceKm = (activity.distance / 1000).toFixed(1);
                        const elevationM = activity.total_elevation_gain ? activity.total_elevation_gain.toFixed(0) : 'N/A';
                        const date = new Date(activity.start_date).toLocaleDateString();
                        const movingTime = activity.moving_time ? formatTime(activity.moving_time) : 'N/A';

                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <b>${activity.name}</b><br>
                                <b>Type:</b> ${activity.type}<br>
                                <b>Distance:</b> ${distanceKm} km<br>
                                <b>Elevation:</b> ${elevationM} m<br>
                                <b>Time:</b> ${movingTime}<br>
                                <b>Date:</b> ${date}<br>
                                <button class="popup-button" onclick="showRoute(${activity.id})">Show Route</button>
                            </div>
                        `);

                        markers.addLayer(marker);
                    }
                });

                map.addLayer(markers);

                // Update count
                document.getElementById('activity-count').textContent =
                    `Showing ${data.count} activities with GPS data`;

                // Auto-fit bounds if we have activities
                if (data.activities.length > 0 && markers.getBounds().isValid()) {
                    map.fitBounds(markers.getBounds(), { padding: [50, 50] });
                }
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('activity-count').textContent =
                    'Error loading activities. Check console for details.';
            }
        }

        // Format time in seconds to readable format
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // Show route for a specific activity
        function showRoute(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity || !activity.polyline) {
                console.error('Activity or polyline not found');
                return;
            }

            // Clear previous routes
            currentPolylines.forEach(p => map.removeLayer(p));
            currentPolylines = [];

            try {
                // Decode polyline
                const coordinates = polyline.decode(activity.polyline);

                // Create polyline
                const route = L.polyline(coordinates, {
                    color: typeColors[activity.type] || '#000000',
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);

                currentPolylines.push(route);

                // Fit bounds to route
                map.fitBounds(route.getBounds(), { padding: [50, 50] });
            } catch (error) {
                console.error('Error decoding polyline:', error);
            }
        }

        // Apply filters
        function applyFilters() {
            const filters = {};

            const type = document.getElementById('type-filter').value;
            if (type) filters.type = type;

            const minDistance = document.getElementById('min-distance').value;
            if (minDistance) filters.min_distance = parseFloat(minDistance) * 1000; // Convert km to m

            const maxDistance = document.getElementById('max-distance').value;
            if (maxDistance) filters.max_distance = parseFloat(maxDistance) * 1000;

            const minElevation = document.getElementById('min-elevation').value;
            if (minElevation) filters.min_elevation = parseFloat(minElevation);

            const maxElevation = document.getElementById('max-elevation').value;
            if (maxElevation) filters.max_elevation = parseFloat(maxElevation);

            loadActivities(filters);
        }

        // Initialize
        loadFilterOptions();
        loadActivities();
    </script>
</body>
</html>
